<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer in Promise Mode</title>
    <script src="https://acrobatservices.adobe.com/view-sdk/viewer.js"></script>
</head>
<body>
    <form id="inputForm">
        <label for="roles">Roles:</label>
        <input type="text" id="roles" name="roles" value="CEO"><br><br>
        <label for="industry">Industry:</label>
        <input type="text" id="industry" name="industry" value="Financial Services"><br><br>
        <label for="companyName">Company Name:</label>
        <input type="text" id="companyName" name="companyName" value="ACME"><br><br>
        <label for="participantNames">Participant Names:</label>
        <input type="text" id="participantNames" name="participantNames" value="John Doe"><br><br>
        <label for="companySituation">Company Situation:</label>
        <input type="text" id="companySituation" name="companySituation" value="Company currently has unresolved support issues"><br><br>
        <button type="button" onclick="submitForm()">Convert HTML to PDF</button>
    </form>

    <div id="adobe-dc-view"></div>

    <script>
        document.addEventListener("adobe_dc_view_sdk.ready", function() {
            // Initialize the AdobeDC View object
            var adobeDCView = new AdobeDC.View({ clientId: "<YOUR_CLIENT_ID>", divId: "adobe-dc-view" });

            async function fetchPDFBase64() {
                const response = await fetch('https://prod-15.canadacentral.logic.azure.com:443/workflows/8151b9e5c79a424faddd0961abbc0494/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IkqSmmRpGzgxMWKyPqWiTZGfcN7_ymngmde6-ABJZcE', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        roles: document.getElementById('roles').value,
                        industry: document.getElementById('industry').value,
                        companyName: document.getElementById('companyName').value,
                        participantNames: document.getElementById('participantNames').value,
                        companySituation: document.getElementById('companySituation').value
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }

                const data = await response.json();
                return data.pdfBase64;  // Assume the response contains the base64 PDF under pdfBase64
            }

            // Convert base64 to ArrayBuffer
            function base64ToArrayBuffer(base64) {
                var binaryString = window.atob(base64);
                var len = binaryString.length;
                var bytes = new Uint8Array(len);
                for (var i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            // Main function to fetch PDF and render using Adobe PDF Embed API
            async function submitForm() {
                try {
                    const base64 = await fetchPDFBase64();
                    const arrayBuffer = base64ToArrayBuffer(base64);

                    // Define linearizationInfoObject and promise for content
                    const linearizationInfoObject = {
                        getInfo: () => getInfo(arrayBuffer),
                        getInitialBuffer: () => getInitialBuffer(arrayBuffer),
                        getFileBufferRanges: ranges => getFileBufferRanges(arrayBuffer, ranges)
                    };

                    // Render PDF using AdobeDC View in Promise Mode
                    adobeDCView.previewFile({
                        content: {
                            promise: Promise.resolve(arrayBuffer),
                            linearizationInfo: linearizationInfoObject
                        },
                        metaData: { fileName: "sample.pdf" }
                    }, {
                        enableLinearization: true,
                    });
                } catch (error) {
                    console.error('Error rendering PDF:', error);
                }
            }

            // Helper functions for linearizationInfoObject
            function getInfo(arrayBuffer) {
                return new Promise((resolve, reject) => {
                    resolve({ fileSize: arrayBuffer.byteLength });
                });
            }

            function getInitialBuffer(arrayBuffer) {
                return new Promise((resolve, reject) => {
                    resolve({ buffer: arrayBuffer.slice(0, 65536) });  // Example: return first 64KB
                });
            }

            function getFileBufferRanges(arrayBuffer, ranges) {
                return new Promise((resolve, reject) => {
                    const bufferList = ranges.map(range => arrayBuffer.slice(range.start, range.end + 1));
                    resolve({ bufferList });
                });
            }
        });
    </script>
</body>
</html>
